generator client {
  provider = "prisma-client-js"
  seed     = "node prisma/seed.ts"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id        Int      @id @default(autoincrement())
  name      String
  email     String   @unique
  password  String
  role      String   @default("rt")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Resident {
  id            Int          @id @default(autoincrement())
  block         String
  houseNumber   String
  fullName      String
  occupancyType String
  houseStatus   String
  notes         String?
  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @default(now()) @updatedAt


  @@unique([block, houseNumber], name: "block_houseNumber")
}

model TransactionType {
  id         Int            @id @default(autoincrement())
  name       String         @unique
  categories Category[]
  entries    FinanceEntry[]
}

model Category {
  id      Int             @id @default(autoincrement())
  name    String
  typeId  Int
  type    TransactionType @relation(fields: [typeId], references: [id])
  entries FinanceEntry[]
}

model FinanceEntry {
  id          Int             @id @default(autoincrement())
  amount      Int
  description String?
  date        DateTime        @default(now())
  categoryId  Int
  typeId      Int
  category    Category        @relation(fields: [categoryId], references: [id])
  type        TransactionType @relation(fields: [typeId], references: [id])
}

model MonthlyFee {
  id           Int      @id @default(autoincrement())

  block        String
  houseNumber  String
  fullName     String
  date         DateTime
  notes        String?

  amount       Int?     // final amount (hasil OCR / edit manual)
  imageUrl     String?

  status       String   @default("PENDING") // PENDING | COMPLETED | FAILED
  rawText      String?
  errorMessage String?
  attempt      Int      @default(0)

  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@index([block])
  @@index([houseNumber])
  @@index([status])
  @@index([date])
}

model CashLedger {
  id          String      @id @default(cuid())
  type        CashType
  amount      Int
  balance     Int?
  description String
  date        DateTime

  bucket      CashBucket  @default(CASH) // ðŸ”¥ BARU

  source      CashSource?
  sourceRef   String?

  createdBy   String?
  createdAt   DateTime    @default(now())
}

model DeferredSubscription {
  id            String   @id @default(cuid())

  // Identitas (tanpa FK)
  block         String
  houseNumber   String

  // Kontrak pembayaran
  totalAmount   Int
  monthlyAmount Int
  remaining     Int

  startMonth    String   // contoh: "2025-01"
  endMonth      String   // contoh: "2025-12"

  isActive      Boolean  @default(true)

  // Metadata
  sourceRef     String?  // optional (string only)
  createdAt     DateTime @default(now())
}

model MonthlyFeeBreakdown {
  id          String   @id @default(cuid())

  // Identitas rumah
  block       String
  houseNumber String
  fullName    String

  // Periode
  month       String   // "YYYY-MM"

  // Total iuran
  totalAmount Int

  // Breakdown
  kasRT       Int
  agamaRT     Int
  sampah      Int
  keamanan    Int
  agamaRW     Int
  kasRW       Int
  kkmRW       Int

  // Metadata
  source      String   // "DEFERRED" | "MONTHLY_FEE"
  sourceRef   String?  // subscriptionId / monthlyFeeId

  createdAt   DateTime @default(now())

  @@unique([block, houseNumber, month])
}

enum CashType {
  IN
  OUT
}

enum CashSource {
  MANUAL
  MONTHLY_FEE
  DONATION
  OTHER
}

enum CashBucket {
  CASH
  DEFERRED
}
